# Security Guide üîí

Comprehensive security guide for 100ms video chat applications.

## Token Types and Usage

### 1. Management Token
- **Purpose**: Authenticate backend requests to 100ms API
- **Usage**: Server-side only, never expose to clients
- **Lifetime**: 7-14 days (configurable)
- **Scope**: Full access to 100ms account

### 2. Auth Token
- **Purpose**: Allow users to join specific rooms
- **Usage**: Client-side, generated by your backend
- **Lifetime**: 24 hours (recommended)
- **Scope**: Limited to specific room and role

## Security Architecture

### ‚ùå Insecure (Current Demo)
```
Client App ‚Üí 100ms API (using management token)
```
**Problems:**
- Management token exposed to all users
- Users can create unlimited rooms
- No user authentication
- No usage control

### ‚úÖ Secure (Production)
```
Client App ‚Üí Your Backend ‚Üí 100ms API
     ‚Üì              ‚Üì           ‚Üì
  Auth Token   Management   Room Data
                Token
```
**Benefits:**
- Management token stays secure
- User authentication required
- Rate limiting and abuse prevention
- Usage tracking and billing control

## Implementation Security

### Backend Security
```javascript
// ‚úÖ Secure: Generate tokens server-side
app.post('/api/rooms/:roomId/token', authenticateUser, (req, res) => {
  const authToken = generateAuthToken({
    roomId: req.params.roomId,
    role: req.body.role,
    userId: req.user.id,
    appAccessKey: process.env.HMS_APP_ACCESS_KEY,
    appSecret: process.env.HMS_APP_SECRET, // Never exposed to client
  });
  
  res.json({ token: authToken });
});

// ‚ùå Insecure: Exposing app_secret to client
// This should NEVER happen in production
```

### Client Security
```typescript
// ‚úÖ Secure: Get tokens from backend
// Note: This method doesn't exist in the current demo service
// It would need to be implemented when adding a backend
const authToken = await hmsService.getAuthToken(roomId, role);
await hmsInstance.join({ authToken });

// ‚ùå Insecure: Using management token directly
// This is what the demo does (for educational purposes only)
```

## Authentication Flow

### 1. User Login
```
User ‚Üí Your App ‚Üí Your Backend ‚Üí Your Auth System
  ‚Üì        ‚Üì           ‚Üì              ‚Üì
Login   Username/   Validate     Generate
Form    Password    Credentials  JWT Token
```

### 2. Room Creation
```
User ‚Üí Your App ‚Üí Your Backend ‚Üí 100ms API
  ‚Üì        ‚Üì           ‚Üì           ‚Üì
Create   JWT Token   Validate    Management
Room     (Header)    User        Token
```

### 3. Room Joining
```
User ‚Üí Your App ‚Üí Your Backend ‚Üí 100ms API
  ‚Üì        ‚Üì           ‚Üì           ‚Üì
Join     JWT Token   Generate    Auth Token
Room     (Header)    Auth Token  for Room
```

## Security Checklist

### Backend Security
- [ ] **HTTPS enabled** for all endpoints
- [ ] **User authentication** implemented
- [ ] **Rate limiting** configured
- [ ] **Input validation** on all endpoints
- [ ] **CORS configured** properly
- [ ] **Logging enabled** for security events

### Token Security
- [ ] **Management tokens** never exposed to clients
- [ ] **Auth tokens** have short lifetimes (24h max)
- [ ] **Token validation** on all protected endpoints
- [ ] **Secure token storage** (not localStorage)

### API Security
- [ ] **Request validation** for all inputs
- [ ] **User authorization** before room access
- [ ] **Room limits** enforced per user
- [ ] **Usage monitoring** implemented

## Common Security Mistakes

### 1. Exposing App Secret
```javascript
// ‚ùå NEVER do this
app.get('/api/config', (req, res) => {
  res.json({
    appSecret: process.env.HMS_APP_SECRET // Exposed!
  });
});
```

### 2. No User Validation
```javascript
// ‚ùå Insecure: No user check
app.post('/api/rooms', (req, res) => {
  // Anyone can create rooms!
  createRoom(req.body);
});
```

### 3. Long-Lived Tokens
```javascript
// ‚ùå Insecure: Tokens that never expire
const token = jwt.sign(payload, secret, {
  expiresIn: '365d' // Too long!
});
```

## Production Deployment

### Environment Variables
```bash
# Production environment
NODE_ENV=production
HMS_APP_ACCESS_KEY=your_production_key
HMS_APP_SECRET=your_production_secret
JWT_SECRET=your_jwt_secret
```

### Monitoring
- **API rate limiting** logs
- **Authentication failures** tracking
- **Room creation** monitoring
- **Token usage** analytics

### Incident Response
- **Token revocation** procedures
- **Rate limit adjustments** for abuse
- **User blocking** capabilities
- **Emergency shutdown** procedures

## Testing Security

### Penetration Testing
1. **Token exposure** - Verify no secrets in client code
2. **Authentication bypass** - Test protected endpoints
3. **Rate limit testing** - Verify abuse prevention
4. **Input validation** - Test malicious inputs

### Security Headers
```javascript
// Security middleware
app.use(helmet()); // Security headers
app.use(rateLimit()); // Rate limiting
app.use(cors({ origin: allowedOrigins })); // CORS
```

## Compliance and Standards

- **GDPR compliance** for user data
- **SOC 2** for enterprise customers
- **HIPAA compliance** for healthcare
- **FERPA compliance** for education

---

**Security is everyone's responsibility.** When in doubt, consult with security experts or the 100ms team.